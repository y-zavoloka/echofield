name: CI/CD Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
  R2_BUCKET: ${{ secrets.R2_BUCKET }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build backend image
        run: docker build -t $IMAGE_NAME:latest .

      - name: Push image
        run: docker push $IMAGE_NAME:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Generate .env file
        run: |
          cat > .env <<EOF
          POSTGRES_DB=echofield
          POSTGRES_USER=echouser
          POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_USER=echouser
          DB_NAME=echofield
          DB_HOST=db
          DEBUG=False
          SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          ALLOWED_HOSTS=echofield.dev,.echofield.dev,static.echofield.dev
          CSRF_TRUSTED_ORIGINS=https://echofield.dev,https://static.echofield.dev
          R2_BUCKET=echofield-static
          R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_S3_REGION_NAME=auto
          R2_CUSTOM_DOMAIN=static.echofield.dev
          USE_R2_STATIC=True
          USE_SSL=True
          EOF

      - name: Copy repo to Droplet
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: "."
          target: "/opt/echofield"
          recursive: true
          strip_components: 0
          overwrite: true
          debug: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            IMAGE_NAME="ghcr.io/y-zavoloka/echofield"
            docker pull $IMAGE_NAME:latest
            cd /opt/echofield
            docker compose down
            docker compose up -d
            docker system prune -f
